<div class="event-timeline-container">
  @if (primaryEvent() && (sortedEvents().length > 0 || undatedEvents().length > 0)) {
    <h2>{{ i18n.t('timeline.title') }}</h2>

    @if (portTransition().length > 0) {
      <div class="port-transition">
        <h3 class="port-transition-title">
          <span class="icon icon-ship" aria-hidden="true"></span>
          {{ i18n.t('timeline.portTransition') }}
        </h3>
        <div class="port-transition-track">
          @for (port of portTransition(); track port.locationCode; let i = $index; let last = $last) {
            <div class="port-node">
              <div class="port-dot"></div>
              <div class="port-info">
                <span class="port-name">{{ port.locationName }}</span>
                <span class="port-code">{{ port.locationCode }}</span>
                @if (port.arrivalTime) {
                  <span class="port-time arrival">
                    {{ i18n.t('timeline.arrivalShort') }}: {{ port.arrivalTime | date:'dd MMM HH:mm' }}
                    @if (port.arrivalTimeType && port.arrivalTimeType !== 'A') {
                      <span class="time-type-badge" [class]="port.arrivalTimeType === 'E' ? 'estimated' : 'planned'">{{ getTimeTypeLabel(port.arrivalTimeType) }}</span>
                    }
                  </span>
                } @else {
                  <span class="port-time unknown">{{ i18n.t('timeline.arrivalShort') }}: —</span>
                }
                @if (port.departureTime) {
                  <span class="port-time departure">
                    {{ i18n.t('timeline.departureShort') }}: {{ port.departureTime | date:'dd MMM HH:mm' }}
                    @if (port.departureTimeType && port.departureTimeType !== 'A') {
                      <span class="time-type-badge" [class]="port.departureTimeType === 'E' ? 'estimated' : 'planned'">{{ getTimeTypeLabel(port.departureTimeType) }}</span>
                    }
                  </span>
                } @else {
                  <span class="port-time unknown">{{ i18n.t('timeline.departureShort') }}: —</span>
                }
                @if (port.dwellTimeHours != null) {
                  <span class="port-dwell" [class.port-dwell-alert]="port.dwellTimeHours >= dwellAlertHours" [title]="port.dwellTimeHours >= dwellAlertHours ? i18n.t('timeline.dwellAlert') : ''">
                    <span class="icon icon-clock" aria-hidden="true"></span>
                    {{ i18n.t('timeline.dwellTime', { hours: port.dwellTimeHours }) }}
                  </span>
                }
              </div>
            </div>
            @if (!last) {
              <div class="port-connector">
                @let vesselChange = getVesselChangeAt(i);
                @if (vesselChange) {
                  <span class="vessel-change-badge" [title]="i18n.t('summary.vesselChange') + ' ' + vesselChange">
                    <span class="icon icon-swap" aria-hidden="true"></span>
                    {{ vesselChange }}
                  </span>
                }
              </div>
            }
          }
        </div>
      </div>
    }

    @if (milestones().length > 0) {
      <div class="milestone-tracker">
        <h3 class="milestone-tracker-title">
          <span class="icon icon-flag" aria-hidden="true"></span>
          {{ i18n.t('milestone.title') }}
        </h3>
        <div class="milestone-track">
          @for (step of milestones(); track step.label; let last = $last) {
            <div class="milestone-step" [class.milestone-completed]="step.completed" [class.milestone-origin]="step.phase === 'origin'" [class.milestone-transit]="step.phase === 'transit'" [class.milestone-destination]="step.phase === 'destination'">
              <div class="milestone-dot">{{ step.completed ? '✓' : '' }}</div>
              <span class="milestone-label">{{ step.label }}</span>
            </div>
            @if (!last) {
              <div class="milestone-connector" [class.milestone-connector-completed]="step.completed"></div>
            }
          }
        </div>
      </div>
    }
    
    <div class="timeline-layout">
      <details class="timeline-index-accordion" open>
        <summary class="timeline-index-summary">{{ i18n.t('timeline.indexLabel') }}</summary>
        <nav class="timeline-index" aria-label="{{ i18n.t('timeline.indexAria') }}">
          <div class="timeline-index-title">{{ i18n.t('timeline.indexLabel') }}</div>
          <ul class="timeline-index-list">
            @for (item of timelineIndex(); track item.anchorId) {
              <li>
                <button
                  type="button"
                  class="timeline-index-link"
                  (click)="scrollToSection(item.anchorId)"
                >
                  <span class="timeline-index-label">{{ item.label }}</span>
                  <span class="timeline-index-count">{{ item.count }}</span>
                </button>
              </li>
            }
          </ul>
        </nav>
      </details>

      <div class="timeline">
        @let labels = eventIndexLabels();
        @for (event of sortedEvents(); track event.eventDateTime; let index = $index) {
          @if (index === 0 || labels[index] !== labels[index - 1]) {
            <div class="timeline-group-label">{{ labels[index] }}</div>
          }

          <div class="timeline-item" [attr.id]="getEventAnchorId(index)" [ngClass]="getLocationTypeClass(event)">
            <div class="timeline-marker">
              <div class="timeline-icon">
                <span class="icon" [ngClass]="getEventIcon(event)" aria-hidden="true"></span>
              </div>
            </div>
            <div class="timeline-content" [ngClass]="getLocationTypeClass(event)">
              <div class="event-header">
                <h3 class="event-type">{{ getEventTypeLabel(event) }}</h3>
                <span class="event-date">{{ event.eventDateTime | date:'medium' }}</span>
              </div>
              <p class="event-description">{{ getEventDescription(event) }}</p>
              
              @if (event.actualTime || event.estimatedTime || event.plannedTime) {
                <div class="event-times">
                  @if (event.actualTime) {
                    <div class="time-item actual">
                      <strong>{{ i18n.t('time.actual') }}:</strong> {{ event.actualTime | date:'medium' }}
                    </div>
                  }
                  @if (event.estimatedTime) {
                    <div class="time-item estimated">
                      <strong>{{ i18n.t('time.estimated') }}:</strong> {{ event.estimatedTime | date:'medium' }}
                    </div>
                  }
                  @if (event.plannedTime) {
                    <div class="time-item planned">
                      <strong>{{ i18n.t('time.planned') }}:</strong> {{ event.plannedTime | date:'medium' }}
                    </div>
                  }
                </div>
              }

              @let etaVar = getEtaVariance(event);
                @if (etaVar) {
                  <div class="eta-variance" [ngClass]="'eta-variance-' + etaVar.tone">
                  <span class="icon icon-clock" aria-hidden="true"></span>
                  {{ etaVar.label }}
                  </div>
                }
              
              <div class="event-details event-details-primary">
                @if (event.location) {
                  <span class="detail-item">
                    <strong>{{ i18n.t('timeline.detail.location') }}</strong> {{ event.location }}
                  </span>
                }
                @if (event.eventCode) {
                  <span class="detail-item">
                    <strong>{{ i18n.t('timeline.detail.eventCode') }}</strong> {{ event.eventCode }}
                  </span>
                }
                @if (event.locationType) {
                  <span class="detail-item">
                    <strong>{{ i18n.t('timeline.detail.locationType') }}</strong> {{ getLocationTypeLabel(event.locationType) }}
                  </span>
                }
              </div>
              @if (hasAdditionalDetails(event)) {
                <details class="event-details-expand">
                  <summary>{{ i18n.t('timeline.moreDetails') }}</summary>
                  <div class="event-details event-details-secondary">
                    @if (event.modeOfTransport) {
                      <span class="detail-item">
                        <strong>{{ i18n.t('timeline.detail.transportMode') }}</strong> {{ event.modeOfTransport }}
                      </span>
                    }
                    @if (event.vessel) {
                      <span class="detail-item">
                        <strong>{{ i18n.t('timeline.detail.vessel') }}</strong> {{ event.vessel }}
                      </span>
                    }
                    @if (event.voyage) {
                      <span class="detail-item">
                        <strong>{{ i18n.t('timeline.detail.voyage') }}</strong> {{ event.voyage }}
                      </span>
                    }
                    @if (event.containerStatus) {
                      <span class="detail-item">
                        <strong>{{ i18n.t('timeline.detail.containerStatus') }}</strong> {{ getContainerStatusLabel(event.containerStatus) }}
                      </span>
                    }
                    @if (event.status) {
                      <span class="detail-item">
                        <strong>{{ i18n.t('timeline.detail.status') }}</strong> {{ getStatusLabel(event) }}
                      </span>
                    }
                    @if (event.facilityName) {
                      <span class="detail-item">
                        <strong>{{ i18n.t('timeline.detail.facility') }}</strong> {{ event.facilityName }}
                      </span>
                    }
                    @if (event.dataProvider) {
                      <span class="detail-item">
                        <strong>{{ i18n.t('timeline.detail.dataProvider') }}</strong> {{ event.dataProvider }}
                      </span>
                    }
                  </div>
                </details>
              }
            </div>
          </div>
        }
      </div>
    </div>

    @if (undatedEvents().length > 0) {
      <div class="undated-events">
        <h3 class="undated-events-title">
          <span class="icon icon-hourglass" aria-hidden="true"></span>
          {{ i18n.t('timeline.unscheduledTitle') }}
        </h3>
        <p class="undated-events-hint">{{ i18n.t('timeline.unscheduledHint') }}</p>
        @for (event of undatedEvents(); track $index) {
          <div class="undated-event-card">
            <div class="event-header">
              <span class="timeline-icon-inline">
                <span class="icon" [ngClass]="getEventIcon(event)" aria-hidden="true"></span>
              </span>
              <h3 class="event-type">{{ getEventTypeLabel(event) }}</h3>
            </div>
            <p class="event-description">{{ getEventDescription(event) }}</p>
            <div class="event-details">
              @if (event.location) {
                <span class="detail-item"><strong>{{ i18n.t('timeline.detail.location') }}</strong> {{ event.location }}</span>
              }
              @if (event.eventCode) {
                <span class="detail-item"><strong>{{ i18n.t('timeline.detail.eventCode') }}</strong> {{ event.eventCode }}</span>
              }
              @if (event.locationType) {
                <span class="detail-item"><strong>{{ i18n.t('timeline.detail.locationType') }}</strong> {{ getLocationTypeLabel(event.locationType) }}</span>
              }
              @if (event.vessel) {
                <span class="detail-item"><strong>{{ i18n.t('timeline.detail.vessel') }}</strong> {{ event.vessel }}</span>
              }
            </div>
          </div>
        }
      </div>
    }
  } @else if (primaryEvent()) {
    <div class="no-events">
      <p>{{ i18n.t('timeline.noEvents') }}</p>
    </div>
  }
</div>
